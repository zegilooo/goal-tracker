<!DOCTYPE html><html lang="en"><head><title>reducers/close-day</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../"><meta name="groc-document-path" content="reducers/close-day"><meta name="groc-project-path" content="src/reducers/close-day.js"><link rel="stylesheet" type="text/css" media="all" href="../assets/style.css"><script type="text/javascript" src="../assets/behavior.js"></script><body><div id="meta"><div class="file-path">src/reducers/close-day.js</div></div><div id="document"><div class="segment"><div class="comments "><div class="wrapper"><h1 id="fermeture-de-journe-reducer">Fermeture de journée (reducer)</h1></div></div></div><div class="segment"><div class="code"><div class="wrapper"><span class="hljs-keyword">import</span> moment <span class="hljs-keyword">from</span> <span class="hljs-string">'moment'</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>On se préoccupe d’une seule action.</p></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">import</span> { CLOSE_DAY } <span class="hljs-keyword">from</span> <span class="hljs-string">'../action-creators'</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>La valeur par défaut est gérée par le meta-réducteur dans <code>index.js</code></p></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">closeDay</span> (<span class="hljs-params">state, action</span>) </span>{
  <span class="hljs-keyword">switch</span> (action.type) {
    <span class="hljs-keyword">case</span> CLOSE_DAY:
      <span class="hljs-keyword">return</span> {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>On garde l&#39;état d&#39;origine, en écrasant toutefois trois champs :</p></div></div><div class="code"><div class="wrapper">        ...state,</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><ul>
<li><code>today</code> (la journée “active” se recale sur aujourd&#39;hui)</li>
</ul></div></div><div class="code"><div class="wrapper">        today: moment().format(<span class="hljs-string">'YYYY-MM-DD'</span>),</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><ul>
<li><code>history</code> (on ajoute une entrée pour le <code>today</code> précédent)</li>
</ul></div></div><div class="code"><div class="wrapper">        history: tallyPreviousDay(state),</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><ul>
<li><code>todaysProgress</code> (on le réinitialise pour cette nouvelle journée)</li>
</ul></div></div><div class="code"><div class="wrapper">        todaysProgress: {}
      }
    <span class="hljs-keyword">default</span>:
      <span class="hljs-keyword">return</span> state
  }
}</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="calcul-de-lhistorisation">Calcul de l’historisation</h2></div></div></div><div class="segment"><div class="code"><div class="wrapper"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">tallyPreviousDay</span> (<span class="hljs-params">{ goals, history, today, todaysProgress }</span>) </span>{
  <span class="hljs-keyword">const</span> historyEntry = {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>À ce stade, <code>today</code> n’a pas encore été modifié, il vaut le dernier
jour pris en compte par l’état.  Il sert donc pour la date de l’entrée
dans l’historique.</p></div></div><div class="code"><div class="wrapper">    date: today,
    progresses: goals.reduce((acc, { id, target }) =&gt; {
      <span class="hljs-keyword">const</span> progress = todaysProgress[id] || <span class="hljs-number">0</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>On n’historise que les progrès non nuls…</p></div></div><div class="code"><div class="wrapper">      <span class="hljs-keyword">if</span> (progress &gt; <span class="hljs-number">0</span>) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>On n’oublie pas de préciser la valeur cible en vigueur, des fois
qu’elle changerait par la suite.</p></div></div><div class="code"><div class="wrapper">        acc[id] = [progress, target]
      }
      <span class="hljs-keyword">return</span> acc
    }, {})
  }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>…et comme d’habitude, la version non-modifiante de <code>push</code>…</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-keyword">return</span> [historyEntry, ...history]
}</div></div></div></div></body></html>