<!DOCTYPE html><html lang="en"><head><title>reducers/goals</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../"><meta name="groc-document-path" content="reducers/goals"><meta name="groc-project-path" content="src/reducers/goals.js"><link rel="stylesheet" type="text/css" media="all" href="../assets/style.css"><script type="text/javascript" src="../assets/behavior.js"></script><body><div id="meta"><div class="file-path">src/reducers/goals.js</div></div><div id="document"><div class="segment"><div class="comments "><div class="wrapper"><h1 id="objectifs-reducer">Objectifs (reducer)</h1></div></div></div><div class="segment"><div class="code"><div class="wrapper"><span class="hljs-keyword">import</span> findIndex <span class="hljs-keyword">from</span> <span class="hljs-string">'lodash.findindex'</span>
<span class="hljs-keyword">import</span> reject <span class="hljs-keyword">from</span> <span class="hljs-string">'lodash.reject'</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>On se préoccupe de 3 actions…</p></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">import</span> { ADD_GOAL, REMOVE_GOAL, UPDATE_GOAL } <span class="hljs-keyword">from</span> <span class="hljs-string">'../action-creators'</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Par défaut, <code>goals</code> vaut <code>[]</code> (pas d’objectifs définis)</p></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">goals</span> (<span class="hljs-params">state = [], action</span>) </span>{
  <span class="hljs-keyword">switch</span> (action.type) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="ajout-dobjectif">Ajout d’objectif</h2></div></div></div><div class="segment"><div class="code"><div class="wrapper">    <span class="hljs-keyword">case</span> ADD_GOAL: {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>On prend les champs qui nous intéressent</p></div></div><div class="code"><div class="wrapper">      <span class="hljs-keyword">const</span> { name, target, units } = action</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>On calcule un nouvel ID d’objectif, qui vaut le maximum
de ceux existants, plus un.  Si aucun objectif n’est défini,
on ferait un <code>Math.max()</code> sans argument, ce qui renverrait
<code>-Infinity</code>, pas top ; par conséquent, on ajoute un dernier
argument, <code>-1</code>, qui garantit une valeur valide au démarrage.
Ainsi, le premier <code>id</code> sera fatalement zéro (-1 + 1).</p></div></div><div class="code"><div class="wrapper">      <span class="hljs-keyword">const</span> id = <span class="hljs-built_in">Math</span>.max(...state.map((goal) =&gt; goal.id), -<span class="hljs-number">1</span>) + <span class="hljs-number">1</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Version “immutable” (génère une nouvelle valeur plutôt que
de modifier le tableau existant) de <code>.push(…)</code>.</p></div></div><div class="code"><div class="wrapper">      <span class="hljs-keyword">return</span> [...state, { id, name, target, units }]
    }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="retrait-dobjectif">Retrait d’objectif</h2></div></div></div><div class="segment"><div class="code"><div class="wrapper">    <span class="hljs-keyword">case</span> REMOVE_GOAL:</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Plutôt que de s’emm… à faire un <code>indexOf</code> suivi de 2 <code>slice(…)</code>, on
délègue à la fonction <a href="https://lodash.com/docs#reject"><code>reject</code> de
LoDash</a> le boulot de retrait, en lui
filant un motif de correspondance sur les objectifs existants.</p></div></div><div class="code"><div class="wrapper">      <span class="hljs-keyword">return</span> reject(state, { id: action.id })</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="mise--jour-voire-ajout-dobjectif">Mise à jour (voire ajout) d’objectif</h2></div></div></div><div class="segment"><div class="code"><div class="wrapper">    <span class="hljs-keyword">case</span> UPDATE_GOAL: {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Inutile de mettre à jour l’ID, et le <code>type</code> ne sert pas à l’objectif.</p></div></div><div class="code"><div class="wrapper">      <span class="hljs-keyword">const</span> { type, ...newGoal } = action</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Où l’objectif est-il présent dans le tableau actuel ?  Plutôt que de
faire une boucle à la main, on délègue au <a href="https://lodash.com/docs#findIndex"><code>findIndex</code> de
LoDash</a>.</p></div></div><div class="code"><div class="wrapper">      <span class="hljs-keyword">const</span> index = findIndex(state, { id: newGoal.id })</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Si l’objectif existait bien dans le tableau, on crée le nouveau
tableau en partant de l’existant pour ne remplacer que l’entrée idoine.</p></div></div><div class="code"><div class="wrapper">      <span class="hljs-keyword">if</span> (index !== -<span class="hljs-number">1</span>) {
        <span class="hljs-keyword">return</span> state.map((goal) =&gt; goal.id === newGoal.id ? newGoal : goal)</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Si ça se trouve, on ne l’avait pas en fait, cet objectif…  Ça ne
devrait pas arriver, mais autant se blinder.  On l’ajoute à la fin,
dans un tel as, comme un ajout mais en préservant l&#39;ID.</p></div></div><div class="code"><div class="wrapper">      }

      <span class="hljs-keyword">return</span> [...state, newGoal]
    }

    <span class="hljs-keyword">default</span>:</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Rappel : un <em>reducer</em> doit <strong>toujours</strong> renvoyer l’état
sans modification si l’action n’est pas applicable.</p></div></div><div class="code"><div class="wrapper">      <span class="hljs-keyword">return</span> state
  }
}</div></div></div></div></body></html>