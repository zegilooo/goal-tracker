<!DOCTYPE html><html lang="en"><head><title>lib/clock</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../"><meta name="groc-document-path" content="lib/clock"><meta name="groc-project-path" content="src/lib/clock.js"><link rel="stylesheet" type="text/css" media="all" href="../assets/style.css"><script type="text/javascript" src="../assets/behavior.js"></script><body><div id="meta"><div class="file-path">src/lib/clock.js</div></div><div id="document"><div class="segment"><div class="comments "><div class="wrapper"><h1 id="rinitialisation-quotidienne">Réinitialisation quotidienne</h1></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Les progrès du jour sont réinitialisés tous les soirs à minuit,
après avoir été ajoutés à l’historique.  Par ailleurs, lorsque
l’application se  lance, si la journée “en cours” dans l’état
global est désormais passée, une historisation est immédiatement
déclenchée.</p>
<p>C’est en fait le <em>reducer</em> consolidé qui fait tout le boulot
côté données : ce module est surtout charger de déclencher
(<code>store.dispatch(…)</code>) la bonne action (<code>CLOSE_DAY</code>) au bon
moment, et de notifier l’utilisateur.</p></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">import</span> moment <span class="hljs-keyword">from</span> <span class="hljs-string">'moment'</span>

<span class="hljs-keyword">import</span> clockIcon <span class="hljs-keyword">from</span> <span class="hljs-string">'../icons/clock-reset.png'</span>
<span class="hljs-keyword">import</span> { closeDay } <span class="hljs-keyword">from</span> <span class="hljs-string">'../action-creators'</span>
<span class="hljs-keyword">import</span> { getCompletionRatio, getDayCounts } <span class="hljs-keyword">from</span> <span class="hljs-string">'../lib/helpers'</span>
<span class="hljs-keyword">import</span> lateIcon <span class="hljs-keyword">from</span> <span class="hljs-string">'../icons/reminder-late.png'</span>
<span class="hljs-keyword">import</span> okayishIcon <span class="hljs-keyword">from</span> <span class="hljs-string">'../icons/reminder-okayish.png'</span>
<span class="hljs-keyword">import</span> superLateIcon <span class="hljs-keyword">from</span> <span class="hljs-string">'../icons/reminder-super-late.png'</span>
<span class="hljs-keyword">import</span> store <span class="hljs-keyword">from</span> <span class="hljs-string">'../store'</span>

let clock = null
let permissionGranted = false</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Activation du vérificateur de rappels à des moments précis de la journée</p></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">const</span> reminder = setInterval(checkReminder, <span class="hljs-number">1000</span>)</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><ol>
<li>On vérifie si on a la permission d’afficher des notifications
système (et sinon, on la (re)demande).</li>
</ol></div></div><div class="code"><div class="wrapper">checkForPermissions()</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><ol>
<li>On vérifie si on n’a pas déjà les progrès d’une journée désormais
passée dans l’état global, auquel cas il faut commencer par
l’historiser.</li>
</ol></div></div><div class="code"><div class="wrapper">checkForTodaysFirstUse()

<span class="hljs-keyword">if</span> (<span class="hljs-built_in">module</span>.hot) {
  <span class="hljs-built_in">module</span>.hot.accept()</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Le HMR sur ce module doit prendre soin d’annuler l’intervalle de
vérification en vigueur, puisque l’initialisation de la nouvelle
version du module va en ré-inscrire un tout de suite.</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-built_in">module</span>.hot.dispose(() =&gt; {
    clearInterval(clock)
    clearInterval(reminder)
  })
}</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>En production, on réinitialise à minuit.
En développement, 10 secondes après le chargement, c’est plus
pratique pour les tests interactifs…</p></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">const</span> HISTORY_TRIGGER_TIME = process.env.NODE_ENV === <span class="hljs-string">'production'</span>
  ? <span class="hljs-string">'00:00:00'</span>
  : moment().add(<span class="hljs-number">10</span>, <span class="hljs-string">'seconds'</span>).format(<span class="hljs-string">'HH:mm:ss'</span>)

<span class="hljs-keyword">const</span> [HISTORY_HOURS, HISTORY_MINUTES, HISTORY_SECONDS] = HISTORY_TRIGGER_TIME.split(<span class="hljs-string">':'</span>).map(<span class="hljs-built_in">Number</span>)</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="vrification-de-lchance">Vérification de l’échéance</h2></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Quand la webapp est ouverte, on vérifie chaque seconde si on a atteint
l’échéance de réinitialisation.  Si tel est le cas, on cloture.</p></div></div><div class="code"><div class="wrapper"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">checkClock</span> (<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">const</span> now = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>()

  <span class="hljs-keyword">if</span> (now.getHours() !== HISTORY_HOURS || now.getMinutes() !== HISTORY_MINUTES || now.getSeconds() !== HISTORY_SECONDS) {
    <span class="hljs-keyword">return</span>
  }

  closePreviousDay()
}</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="permission-de-notifier">Permission de notifier</h2></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Le recours aux <a href="https://developer.mozilla.org/fr/docs/Web/API/notification/Using_Web_Notifications">notifications</a>
“système” n’est pas automatiquement
possible : l’utilisateur doit nous l’avoir accordé.  Au démarrage
de la webapp, quand ce module est initialisé, on vérifie si on
la permission, et si tel n’est pas le cas, on la redemande. Le
résultat est stocké comme booléen dans <code>permissionGranted</code>.</p></div></div><div class="code"><div class="wrapper"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">checkForPermissions</span> (<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-built_in">window</span> === <span class="hljs-string">'undefined'</span> || !<span class="hljs-built_in">window</span>.Notification) {
    <span class="hljs-keyword">return</span>
  }

  permissionGranted = <span class="hljs-built_in">window</span>.Notification.permission === <span class="hljs-string">'granted'</span>
  <span class="hljs-keyword">if</span> (!permissionGranted) {
    <span class="hljs-built_in">window</span>.Notification.requestPermission((status) =&gt; {
      permissionGranted = status === <span class="hljs-string">'granted'</span>
    })
  }
}</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="historisation-au-dmarrage">Historisation au démarrage</h2></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Au démarrage de la webapp, quand ce module est initialisé, on
vérifie si la journée “en cours” de l’état central n’est pas
passée, ce qui veut dire que la webapp n’était pas ouverte à
minuit cette journée-là, et que l’historisation reste à faire;
On la déclenche donc.</p></div></div><div class="code"><div class="wrapper"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">checkForTodaysFirstUse</span> (<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">const</span> storesLastDay = store.getState().today
  <span class="hljs-keyword">if</span> (storesLastDay &amp;&amp; moment(storesLastDay).isBefore(moment(), <span class="hljs-string">'day'</span>)) {
    closePreviousDay()
  }

  clock = setInterval(checkClock, <span class="hljs-number">1000</span>)
}</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="rappels--des-moments-prcis">Rappels à des moments précis</h2>
<p>À des heures précises (12h, 18h, 21h, 23h) l’appli fait le point sur
la progression générale et, le cas échéant, affichera un rappel si on
est plus ou moins à la bourre.</p>
<p>En développement, on fait ça 5 secondes après le chargement.</p></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">const</span> REMINDER_TIMES = process.env.NODE_ENV === <span class="hljs-string">'production'</span>
  ? [<span class="hljs-number">12</span>, <span class="hljs-number">18</span>, <span class="hljs-number">21</span>, <span class="hljs-number">23</span>].map((hour) =&gt; [hour, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>])
  : [moment().add(<span class="hljs-number">5</span>, <span class="hljs-string">'seconds'</span>).format(<span class="hljs-string">'HH:mm:ss'</span>).split(<span class="hljs-string">':'</span>).map(<span class="hljs-built_in">Number</span>)]

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">checkReminder</span> (<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">if</span> (!permissionGranted) {
    <span class="hljs-keyword">return</span>
  }

  <span class="hljs-keyword">const</span> now = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>()
  <span class="hljs-keyword">if</span> (REMINDER_TIMES.some(([hour, min, sec]) =&gt; hour === now.getHours() &amp;&amp; min === now.getMinutes() &amp;&amp; sec === now.getSeconds())) {
    notifyReminder()
  }
}</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="fonctions-utilitaires">Fonctions utilitaires</h2></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Déclenchement de l’historisation auprès du <em>store</em> central,
et notification si on en a le droit.</p></div></div><div class="code"><div class="wrapper"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">closePreviousDay</span> (<span class="hljs-params"></span>) </span>{
  store.dispatch(closeDay())

  <span class="hljs-keyword">if</span> (permissionGranted) {
    notify({
      title: <span class="hljs-string">'Fin de journée !'</span>,
      text: <span class="hljs-string">'Vos objectifs ont été historisés et repartent à zéro.'</span>,</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Remarquez qu’ici <code>clockIcon</code> est en fait une URL, obtenue
via l’<code>import</code> grâce aux
<a href="https://github.com/webpack/url-loader"><code>url-loader</code></a> et
<a href="https://github.com/webpack/file-loader"><code>file-loader</code></a> de
Webpack.  Si le PNG correspondant faisait moins de 10Ko,
il aurait même était injecté sous forme base64 plutôt que
comme un fichier distinct, économisant une requête HTTP.</p></div></div><div class="code"><div class="wrapper">      icon: clockIcon,
      secondsVisible: <span class="hljs-number">4</span>
    })
  }
}</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Notification générique avec fermeture automatique.</p></div></div><div class="code"><div class="wrapper"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">notify</span> (<span class="hljs-params">{ title, text, icon, secondsVisible = 0 }</span>) </span>{
  <span class="hljs-keyword">const</span> notif = <span class="hljs-keyword">new</span> <span class="hljs-built_in">window</span>.Notification(title, { body: text, tag: <span class="hljs-string">'goal-tracker'</span>, icon })
  <span class="hljs-keyword">if</span> (secondsVisible &gt; <span class="hljs-number">0</span>) {
    notif.addEventListener(<span class="hljs-string">'show'</span>, () =&gt; {
      setTimeout(() =&gt; notif.close(), secondsVisible * <span class="hljs-number">1000</span>)
    })
  }
}</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Notification de retard à contenu variable.</p></div></div><div class="code"><div class="wrapper"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">notifyReminder</span> (<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">const</span> state = store.getState()
  <span class="hljs-keyword">const</span> [totalProgress, totalTarget] = getDayCounts(state.todaysProgress, state.goals)
  <span class="hljs-keyword">const</span> ratio = getCompletionRatio(totalProgress, totalTarget)

  <span class="hljs-keyword">let</span> [title, icon] = []
  <span class="hljs-keyword">if</span> (ratio &lt; <span class="hljs-number">0.5</span>) {
    [title, icon] = [<span class="hljs-string">'Tu es super à la bourre !'</span>, superLateIcon]
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (ratio &lt; <span class="hljs-number">0.75</span>) {
    [title, icon] = [<span class="hljs-string">'Tu es à la bourre…'</span>, lateIcon]
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (ratio &lt; <span class="hljs-number">0.9</span>) {
    [title, icon] = [<span class="hljs-string">'Tu es un peu à la bourre…'</span>, okayishIcon]
  }
  <span class="hljs-keyword">if</span> (title != <span class="hljs-literal">null</span>) {
    notify({
      title,
      text: <span class="hljs-string">`Il te reste <span class="hljs-subst">${totalTarget - totalProgress}</span> tâches (sur <span class="hljs-subst">${totalTarget}</span>) à accomplir aujourd’hui.`</span>,
      icon,
      secondsVisible: <span class="hljs-number">8</span>
    })
  }
}</div></div></div></div></body></html>