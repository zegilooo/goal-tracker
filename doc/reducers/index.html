<!DOCTYPE html><html lang="en"><head><title>reducers/index</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../"><meta name="groc-document-path" content="reducers/index"><meta name="groc-project-path" content="src/reducers/index.js"><link rel="stylesheet" type="text/css" media="all" href="../assets/style.css"><script type="text/javascript" src="../assets/behavior.js"></script><body><div id="meta"><div class="file-path">src/reducers/index.js</div></div><div id="document"><div class="segment"><div class="comments "><div class="wrapper"><h1 id="reducer-combin-global">Reducer combiné global</h1></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Selon la <a href="http://redux.js.org/docs/basics/Reducers.html#splitting-reducers">meilleure pratique Redux</a>,
nous avons réalisé
indépendamment les <em>reducers</em> des diverses parties de l’état.
On va utiliser <a href="http://redux.js.org/docs/api/combineReducers.html"><code>combineReducers</code></a>
pour les recombiner en un seul,
qui délèguera automatiquement aux nôtres, champ par champ.</p>
<p>Toutefois, une action (<code>CLOSE_DAY</code>) impacte plusieurs champs
(en l’occurrence, <code>todaysProgress</code> et <code>history</code>), de sorte que
nous allons la traiter dans le reducer consolidé.</p></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">import</span> { combineReducers } <span class="hljs-keyword">from</span> <span class="hljs-string">'redux'</span>
<span class="hljs-keyword">import</span> { persistentReducer } <span class="hljs-keyword">from</span> <span class="hljs-string">'redux-pouchdb'</span>

<span class="hljs-keyword">import</span> { CLOSE_DAY } <span class="hljs-keyword">from</span> <span class="hljs-string">'../action-creators'</span>
<span class="hljs-keyword">import</span> closeDay <span class="hljs-keyword">from</span> <span class="hljs-string">'./close-day'</span>
<span class="hljs-keyword">import</span> currentUser <span class="hljs-keyword">from</span> <span class="hljs-string">'./current-user'</span>
<span class="hljs-keyword">import</span> goals <span class="hljs-keyword">from</span> <span class="hljs-string">'./goals'</span>
<span class="hljs-keyword">import</span> history <span class="hljs-keyword">from</span> <span class="hljs-string">'./history'</span>
<span class="hljs-keyword">import</span> today <span class="hljs-keyword">from</span> <span class="hljs-string">'./today'</span>
<span class="hljs-keyword">import</span> todaysProgress <span class="hljs-keyword">from</span> <span class="hljs-string">'./todays-progress'</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>On crée le reducer consolidé…</p></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">const</span> coreReducer = combineReducers({</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>… basé sur nos reducers individuels pour chaque partie…</p></div></div><div class="code"><div class="wrapper">  currentUser, goals, history, today, todaysProgress
})</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Ensuite, on définit le reducer final exporté par ce module,
qui sera donc celui exploité par le <em>store</em> Redux, afin de traiter
les actions multi-champs.</p>
<p>Si on n’a pas d’état transmis (cas à la première utilisation,
notamment), on va déléguer aux reducers individuels la mise en
place de leurs valeurs par défaut respectives.  Ainsi, pas de
duplication de définition des valeurs par défaut.</p></div></div><div class="code"><div class="wrapper"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">goalTrackerReducer</span> (<span class="hljs-params">state, action</span>) </span>{
  <span class="hljs-keyword">if</span> (state == <span class="hljs-literal">null</span>) {
    state = coreReducer(state, {})
  }

  <span class="hljs-keyword">switch</span> (action.type) {
    <span class="hljs-keyword">case</span> CLOSE_DAY:</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Cloture de journée et historisation</p></div></div><div class="code"><div class="wrapper">      <span class="hljs-keyword">return</span> closeDay(state, action)
    <span class="hljs-keyword">default</span>:</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Rappel : un <em>reducer</em> doit <strong>toujours</strong> renvoyer l’état
sans modification si l’action n’est pas applicable.</p></div></div><div class="code"><div class="wrapper">      <span class="hljs-keyword">return</span> coreReducer(state, action)
  }
}</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Afin de finaliser la synchronisation entre le <em>store</em> Redux et
PouchDB (voir <code>store.js</code>), on doit enrober les <em>reducers</em> dont le résultat
doit être synchronisé par le <code>persistentReducer</code> exporté par <code>redux-pouchdb</code>.
Comme ici l’ensemble des actions est pertinent, on n’enrobe qu’une fois,
au niveau du <em>reducer</em> consolidé.</p></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> persistentReducer(goalTrackerReducer)</div></div></div></div></body></html>